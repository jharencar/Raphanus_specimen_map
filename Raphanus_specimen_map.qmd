---
title: "Raphanus_specimen_map"
author: "Julia Harenčár"
date: "07/05/2023"
execute:
  echo: true #will keep code chunks
  warning: false #removes warning functions
format: 
  html: 
    self-contained: true #makes one html file to render that is sharable
    page-layout: full #uses the full page
    code-fold: true #lets user fold up codes
    code-tools: true #makes an option in the upper left for users to reveal/hide all code and copy source code
    #makes long lines of code rap
    code-overflow: wrap
    #makes table of contents
    toc: true
    #sets location of table of contents
    toc-location: left
#set theme settings. in this case user can switch between light and dark mode
theme:
  #give light option
  light: flatly
  #give dark option
  dark: darkly
---

## *Raphanus* specimen maps

Creating maps of *Raphanus* specimen locations and collection years.\
\

```{r load libraries}
# load libraries
library(tidyverse)
library(ggplot2)
library(maps)
library(ggmap)
library(grid)
library(patchwork)
library(plotly)
library(htmlwidgets)
```
# Reading in and cleaning data
```{r import and clean data}
# Read in gbif data; search for "Raphanus L.", occurance status present, with or without coordinates, and US only.

# Citation: GBIF.org (20 July 2023) GBIF Occurrence Download https://doi.org/10.15468/dl.2srzch

gbif_full <- read.csv("gbif_Raphanus_all_present.csv", header = T)

# pare down gbif data:remove rows without a collection year, remove rows with no county AND no coordinates, remove " County" and "Co." from county names so each county only has one name.
string_to_remove <- c(" County", " Co.")

gbif <- gbif_full %>%
  select(scientificName, year, stateProvince, county, decimalLatitude, decimalLongitude, recordedBy, basisOfRecord) %>%
  drop_na(year) %>%
  filter(!is.na(decimalLatitude) & !is.na(county)) %>%
  mutate(county = str_remove_all(county, paste(string_to_remove, collapse = "|")))

# fill missing lat and long with the average lat or long for that county
# Use ifelse to conditionally fill missing lat and long only when there is a county present
gbif2 <- gbif %>%
  group_by(county) %>%
  mutate(
    decimalLatitude = ifelse(!is.na(county) & is.na(decimalLatitude), mean(decimalLatitude, na.rm = TRUE), decimalLatitude),
    decimalLongitude = ifelse(!is.na(county) & is.na(decimalLongitude), mean(decimalLongitude, na.rm = TRUE), decimalLongitude)
  ) %>%
  drop_na(decimalLatitude)

# get map
# register_google(key = "AIzaSyB39SQ16tq5W05hnFRHx6CVSKzH1iq1Mf0")
map <- get_map(location = c(lon=-100 , lat= 40), zoom =3, maptype = "terrain")
# ggmap(map) # for testing map

# Separate out only the herbarium specimen records
gbif_spec2 <- gbif2 %>%
filter(basisOfRecord == "PRESERVED_SPECIMEN")

# simplify scientific name to make distinguishing sativus and raphanistrum possible
# Create a new column with simplified names
gbif_spec2 <- gbif_spec2 %>%
  mutate(simplifiedName = case_when(
    startsWith(scientificName, "Raphanus raphanistrum") ~ "Raphanus raphanistrum",
    startsWith(scientificName, "Raphanus sativus") ~ "Raphanus sativus",
    TRUE ~ scientificName  # Keep the original name if it doesn't match the patterns above
  ))

```
## Plot specimen collection locations
```{r plot all specimens}
# plot all herbarium specimen locations on one map
Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec2, size = 2, aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName), color = "black") +
  ylim(25, 50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "Raphanus specimen collection locations")

#ggsave("gbif_all_Raphanus_specimen_map.pdf", Raph_spec_map, width = 7, height = 4.5, units = "in")

# Try making an interactive plot
interactive_plot <- 
  plot_ly(data = gbif_spec2, 
          type = "scattermapbox", 
          mode = "markers", 
          hoverinfo = "text",
          lat = ~decimalLatitude, 
          lon = ~decimalLongitude,
          text = ~paste("Scientific Name: ", simplifiedName, "<br>Year: ", year),
          marker = list(size = 8, color = ~year, colorscale = "Spectral", cmin = min(gbif_spec2$year), cmax = max(gbif_spec2$year))) %>%
  layout(title = "Raphanus specimen collection locations",
         mapbox = list(style = "open-street-map", zoom = 4, center = list(lat = 37.5, lon = -95)),
         xaxis = list(showgrid = FALSE, zeroline = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE))

# Display the interactive plot
interactive_plot

# Save the interactive plot to share
saveWidget(interactive_plot, "interactive_specimen_by_year_plot.html")

# Attempt to add diff symbols for diff species... medium successful
# First, need to convert simplifiedName to a factor with numeric values so it can be used to code different shapes
gbif_spec2$symbol <- as.numeric(factor(gbif_spec2$simplifiedName))

# Make the plot
interactive_plot2 <- plot_geo(gbif_spec2, lat = ~decimalLatitude, lon = ~decimalLongitude, color = ~year, colors = "Spectral",
                             symbol = ~symbol, symbols = c("circle", "cross", "triangle-up", "diamond"),
                             marker = list(size = 8), mode = "markers") %>%
  layout(title = "Raphanus specimen collection locations",
         mapbox = list(style = "open-street-map", zoom = 4, center = list(lat = 37.5, lon = -95)))

# Display the interactive plot
#interactive_plot2

# Plot only raphanistrum
gbif_spec_raph <- gbif_spec2 %>%
filter(scientificName == "Raphanus raphanistrum L.")
 
Raph_spec_raph_map <- ggmap(map) +
  geom_point(data = gbif_spec_raph, size = 2, pch = 21, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  labs(title = "gbif R. raphinastrum specimen collection locations")

# only sativus
gbif_spec_sati <- gbif_spec2 %>%
filter(scientificName == "Raphanus sativus L.")
 
Raph_spec_sati_map <- ggmap(map) +
  geom_point(data = gbif_spec_sati, size = 2, pch = 21, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  labs(title = "gbif R. sativus specimen collection locations")

# only hybrids - not bothering, it is only 2 specimens from CA in 2007 and 2013
gbif_spec_hyb <- gbif_spec2 %>%
filter(scientificName == "Raphanus raphanistrum × sativus")

# no genus and hybrids - not bothering, only 35, quite a few in mexico
gbif_spec_hyb.no <- gbif_spec2 %>%
filter(scientificName %in% c("","Raphanus raphanistrum × sativus"))
 
# patchwork multipanel plot to compare species
gbif_2panel <- Raph_spec_sati_map/Raph_spec_raph_map

ggsave("gbif_R.sativus_R.raphinastrum_specimens_map.pdf", gbif_2panel, width = 7, height = 9, units = "in")
```
## Plot and count by county
```{r plot by county}

# plot by county in California
CA_barplot_by_spp.co <- gbif_spec2 %>% 
  filter(stateProvince == "California") %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  ggplot(aes(x=county, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("CA_barplot_by_spp.co.pdf", CA_barplot_by_spp.co, width = 14, height = 7, units = "in")

# Get just the per county counts from most to least:
CA_per_co_counts <- gbif_spec2 %>% 
  filter(stateProvince == "California") %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  arrange(desc(count))

write.csv(CA_per_co_counts, file = "CA_per_co_counts.csv", row.names = FALSE)

# plot by county in NW
NW_barplot_by_spp.co <- gbif_spec2 %>% 
  filter(stateProvince %in% c("Washington","Oregon")) %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  ggplot(aes(x=county, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("NW_barplot_by_spp.co.pdf", NW_barplot_by_spp.co, width = 14, height = 7, units = "in")

# Get just the per county counts from most to least:
NW_per_co_counts <- gbif_spec2 %>% 
  filter(stateProvince %in% c("Washington","Oregon")) %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  arrange(desc(count))

write.csv(NW_per_co_counts, file = "NW_per_co_counts.csv", row.names = FALSE)

# plot by county in NE
NE_barplot_by_spp.co <- gbif_spec2 %>% 
  filter(stateProvince %in% c("Maine", "Vermont", "New Hampshire", "Pennsylvania", "Massachusetts" , "Rhode Islande", "Connecticut", "New York", "New Jersey","Delaware", "Maryland", "District of Columbia")) %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  ggplot(aes(x=county, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("NE_barplot_by_spp.co.pdf", NE_barplot_by_spp.co, width = 14, height = 7, units = "in")

# Get just the per county counts from most to least:
NE_per_co_counts <- gbif_spec2 %>% 
  filter(stateProvince %in% c("Maine", "Vermont", "New Hampshire", "Pennsylvania", "Massachusetts" , "Rhode Islande", "Connecticut", "New York", "New Jersey","Delaware", "Maryland", "District of Columbia")) %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  arrange(desc(count))

write.csv(NE_per_co_counts, file = "NE_per_co_counts.csv", row.names = FALSE)

# plot by county in SE
SE_barplot_by_spp.co <- gbif_spec2 %>% 
  filter(stateProvince %in% c("Virginia", "North Carolina", "South Carolina", "Tennesee", "Georgia", "Alabama", "Florida", "Mississippi", "Louisiana", "Arkansas")) %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  ggplot(aes(x=county, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("SE_barplot_by_spp.co.pdf", SE_barplot_by_spp.co, width = 14, height = 7, units = "in")

# Get just the per county counts from most to least:
SE_per_co_counts <- gbif_spec2 %>% 
  filter(stateProvince %in% c("Virginia", "North Carolina", "South Carolina", "Tennesee", "Georgia", "Alabama", "Florida", "Mississippi", "Louisiana", "Arkansas")) %>% 
  group_by(county, simplifiedName) %>%
  summarise(count = n()) %>% 
  arrange(desc(count))

write.csv(SE_per_co_counts, file = "SE_per_co_counts.csv", row.names = FALSE)
```


## Plotting only old specimen locations
```{r plot based on time period}
## Plot only old specimens
# Plot only pre 1900 specimen locations
gbif_spec_pre1900 <- gbif_spec2 %>% 
  filter(year <= 1900)

pre1900_Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec_pre1900, size = 2, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "1900 and older Raphanus specimen collection locations")

# Plot 1900 to 1920 specimen locations
gbif_spec_1900to1920 <- gbif_spec2 %>% 
  filter(year <= 1920 & year >= 1900)

btw_1900.1920_Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec_1900to1920, size = 2, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "1900-1920 Raphanus specimen collection locations")

# save multipanel 
old_spec <- pre1900_Raph_spec_map/btw_1900.1920_Raph_spec_map

ggsave("pre_1900+1900-1920_specimen_maps.pdf", old_spec, width = 7, height = 9, units = "in")

# create plots for each 20 year period to inform sampling plan

# 1920-40
gbif_spec_1920to1940 <- gbif_spec2 %>% 
  filter(year >= 1920 & year <= 1940)

btw_1920.1940_Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec_1920to1940, size = 2, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "1920-1940 Raphanus specimen collection locations")

# 1940-60
gbif_spec_1940to1960 <- gbif_spec2 %>% 
  filter(year >= 1940 & year <= 1960)

btw_1940.1960_Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec_1940to1960, size = 2, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "1940-1960 Raphanus specimen collection locations")

# 1960-80
gbif_spec_1960to1980 <- gbif_spec2 %>% 
  filter(year >= 1960 & year <= 1980)

btw_1960.1980_Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec_1960to1980, size = 2, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "1960-1980 Raphanus specimen collection locations")

# 1980-2000
gbif_spec_1980to2000 <- gbif_spec2 %>% 
  filter(year >= 1980 & year <= 2000)

btw_1980.2000_Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec_1980to2000, size = 2, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "1980-2000 Raphanus specimen collection locations")

# 2000-2023
gbif_spec_2000to2023 <- gbif_spec2 %>% 
  filter(year >= 2000)

btw_2000.2023_Raph_spec_map <- ggmap(map) +
  geom_point(data = gbif_spec_2000to2023, size = 2, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year, shape = simplifiedName)) +
  ylim(25,50) +
  xlim(-124, -65) +
  scale_fill_distiller(palette = "Spectral") +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "2000-2023 Raphanus specimen collection location")
  
# make into a multipanel plot
map_panel_20yr_periods <- (btw_1900.1920_Raph_spec_map/btw_1920.1940_Raph_spec_map/btw_1940.1960_Raph_spec_map) | (btw_1960.1980_Raph_spec_map/btw_1980.2000_Raph_spec_map/btw_2000.2023_Raph_spec_map)

# save
ggsave("map_panel_20yr_periods.pdf", map_panel_20yr_periods, width = 14, height = 15, units = "in")

```
# Plot all occurance/observation data
```{r}
# plot all points (including observation data) on map
Raph_all_map <- ggmap(map) +
  geom_point(data = gbif, size = 2, pch = 21, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year)) +
  ylim(14,52) +
  xlim(-127, -56) +
  scale_fill_distiller(palette = "Spectral") +
  labs(title = "gbif all Raphanus spp. records")

## plot all occurance/observation data
# all spp together
gbif_occ <- gbif %>%
filter(basisOfRecord %in% c("HUMAN_OBSERVATION", "OCCURRENCE", "OBSERVATION"))
 
Raph_occ_map <- ggmap(map) +
  geom_point(data = gbif_occ, size = 2, pch = 21, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year)) +
  ylim(14,52) +
  xlim(-127, -56) +
  scale_fill_distiller(palette = "Spectral") +
  labs(title = "gbif Raphanus spp. occurance/observation locations")

# only raphinastrum

# only sativus

#ggsave("gbif_Raphanus_occurance_map.pdf", Raph_occ_map)

```


## Tables and plots of number of specimens through time in different regions
```{r}
## Make a table for each 20 year period since 1920 (oldest is 1927)
# the dataframe has already been filtered to only include herbarium specimen records from North America
# Create a new column for 20-year periods
gbif_spec2 <- gbif_spec2 %>%
  mutate(period = paste0(floor(year / 20) * 20, "-", floor(year / 20) * 20 + 19))

# Count the number of rows for each 20-year period
count_by_period_table <- gbif_spec2 %>%
  group_by(period) %>%
  summarise(count = n())

## Now I will break it down by focal region:

# California
# Count the number of rows for each 20-year period, each county, and each simplifiedName
California_count_by_per.co.sp <- gbif_spec2 %>%
  filter(stateProvince == "California") %>%
  group_by(period, stateProvince, county, simplifiedName) %>%
  summarise(count = n())

# export to csv
write.csv(California_count_by_per.co.sp, file = "California_specimen_count_by_per.co.sp.csv", row.names = FALSE)

# Plot just San Diego because the most samples 
SD_barplot_by_spp.period <- California_count_by_per.co.sp %>% 
  filter(county == "San Diego") %>% 
  ggplot(aes(x=period, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("SD_barplot_by_spp.period.pdf", SD_barplot_by_spp.period, width = 14, height = 7, units = "in")


# Washinton & Oregon (NW)
# Count the number of rows for each 20-year period, each county, and each simplifiedName
NW_count_by_per.co.sp <- gbif_spec2 %>%
  filter(stateProvince %in% c("Washington","Oregon")) %>%
  group_by(period, stateProvince, county, simplifiedName) %>%
  summarise(count = n())

# export to csv
write.csv(NW_count_by_per.co.sp, file = "NW_specimen_count_by_per.co.sp.csv", row.names = FALSE)

# The North East (NE)
# Count the number of rows for each 20-year period, each county, and each simplifiedName
NE_count_by_per.co.sp <- gbif_spec2 %>%
  filter(stateProvince %in% c("Maine", "Vermont", "New Hampshire", "Pennsylvania", "Massachusetts" , "Rhode Islande", "Connecticut", "New York", "New Jersey","Delaware", "Maryland", "District of Columbia")) %>%
  group_by(period, stateProvince, county, simplifiedName) %>%
  summarise(count = n())

# export to csv
write.csv(NE_count_by_per.co.sp, file = "NE_specimen_count_by_per.co.sp.csv", row.names = FALSE)

# The South East (SE)
# Count the number of rows for each 20-year period, each county, and each simplifiedName
SE_count_by_per.co.sp <- gbif_spec2 %>%
  filter(stateProvince %in% c("Virginia", "North Carolina", "South Carolina", "Tennesee", "Georgia", "Alabama", "Florida", "Mississippi", "Louisiana", "Arkansas")) %>%
  group_by(period, stateProvince, county, simplifiedName) %>%
  summarise(count = n())

# export to csv
write.csv(SE_count_by_per.co.sp, file = "SE_specimen_count_by_per.co.sp.csv", row.names = FALSE)
```
# Plot 5 year intervals
```{r plotting 5 yr intervals}
# Create a new column for 5-year periods
gbif_spec2 <- gbif_spec2 %>%
  mutate(period5 = paste0(floor(year / 5) * 5, "-", floor(year / 5) * 5 + 4))

# Count the number of rows for each 5-year period
count_by_period5_table <- gbif_spec2 %>%
  group_by(period5, simplifiedName) %>%
  summarise(count = n())

# Plot frequency through time in 5 yr intervals, color by spp, all data
barplot_by_spp.period5 <- count_by_period5_table %>% 
  ggplot(aes(x=period5, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("all_barplot_by_spp.period5.pdf", barplot_by_spp.period5, width = 14, height = 7, units = "in")

## Now I will break it down by focal region:

#SoCA
SoCA_count_by_per5.sp <- gbif_spec2 %>%
  filter(stateProvince == "California" & county %in% c("San Diego", "Santa Barbara", "Orange", "Riverside", "Los Angeles", "Ventura", "San Bernardino", "San Luis Obispo")) %>%
  group_by(period5, simplifiedName) %>%
  summarise(count = n())

# Plot frequency through time in 5 yr intervals, color by spp, all data
SoCA_barplot_by_spp.period5 <- SoCA_count_by_per5.sp %>% 
  ggplot(aes(x=period5, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("SoCA_barplot_by_spp.period5.pdf", SoCA_barplot_by_spp.period5, width = 14, height = 7, units = "in")

# look at yearly instead of by period:
SoCA_yrly_count_by_sp <- gbif_spec2 %>%
  filter(stateProvince == "California" & county %in% c("San Diego", "Santa Barbara", "Orange", "Riverside", "Los Angeles", "Ventura", "San Bernardino", "San Luis Obispo")) %>%
  group_by(year, simplifiedName) %>%
  summarise(count = n())

# Plot frequency through time in 5 yr intervals, color by spp, all data
SoCA_yrly_barplot_by_spp <- SoCA_yrly_count_by_sp %>% 
  ggplot(aes(x=year, y=count, fill=simplifiedName)) + 
  geom_bar(stat = "identity") +
  labs(y = "Number of Individuals") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("SoCA_yrly_barplot_by_spp.pdf", SoCA_yrly_barplot_by_spp, width = 14, height = 7, units = "in")

SoCA_1965 <- gbif_spec2 %>% filter(stateProvince == "California" & county %in% c("San Diego", "Santa Barbara", "Orange", "Riverside", "Los Angeles", "Ventura", "San Bernardino", "San Luis Obispo") & year =="1965") 

# looking at crazy high collection count in soCal in 1965 in more detail
ggmap(map) +
  geom_point(data=SoCA_1965, size = 2, aes(x = decimalLongitude, y = decimalLatitude, shape = simplifiedName), color = "black") +
  ylim(30, 35) +
  xlim(-122, -115) +
  scale_shape_manual(values = c("Raphanus sativus" = 21, "Raphanus raphanistrum" = 24, "Raphanus L." = 23)) +
  labs(title = "Raphanus specimen collection locations")

```


#Playing with some summary plots
```{r}
# Stacked Bar Plot - too much with all the counties, but will be helpful looking at chosen counties and shorter time intervals
ggplot(California_count_by_per.co.sp, aes(x = period, y = count, fill = simplifiedName)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ county, scales = "free") +
  labs(title = "Specimen Counts by Scientific Name for each County and Time Period",
       x = "Time Period",
       y = "Count of Specimens") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# CCH2 data only
```{r}
# Read in occurance data from CCH2 search for "Raphanus" (had to delete verbatim coordinates because contain crazy characters)
occ_full <- read.csv("Raphanus_occurrences.csv", header = T)

# pare down data: keep only reccords from CA, remove rows without a collection year, remove " County" and "Co." from county names so each county only has one name. 
string_to_remove <- c(" County", " Co.")
occ <- occ_full %>% 
  select(id, simplifiedName, genus, specificEpithet, year, stateProvince, county, decimalLatitude, decimalLongitude) %>% 
  filter(stateProvince == "California") %>% 
  drop_na(year, county) %>% 
  mutate(county = str_remove_all(county, paste(string_to_remove, collapse = "|")))
  
# fill in missing coordinates with a genereic per county point
# determine which counties are represented:
unique(occ$county)

# fill missing lat and long with the average lat or long for that county
occ2 <- occ %>%
  filter(!county =="") %>% 
  group_by(county) %>%
  mutate(decimalLatitude = ifelse(is.na(decimalLatitude), mean(decimalLatitude, na.rm = TRUE), decimalLatitude),
         decimalLongitude = ifelse(is.na(decimalLongitude), mean(decimalLongitude, na.rm = TRUE), decimalLongitude)) %>% 
  drop_na(decimalLatitude)
  
## Plot on map of CA  
# compute the bounding box for sample map
bbox <- make_bbox(lat = decimalLatitude, lon = decimalLongitude, data = occ2)

# adjust right bound to include all of CA
bbox["right"] <- -114.00

# get map of CA
# register_google(key = "AIzaSyB39SQ16tq5W05hnFRHx6CVSKzH1iq1Mf0")
california_map <- get_map(location = bbox, zoom = 6, maptype = "terrain")

# reverse order for plotting
occ2 <- occ2[order(-occ2$year), ]

# plot points on map
Raph_map <- ggmap(california_map) +
  geom_point(data = occ2, size = 2, pch = 21, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year)) +
  scale_fill_distiller(palette = "Spectral") +
  labs(title = "CCH2 all Raphanus spp. specimen locations")
  
ggsave("CCH2_Raphanus_specimen_map.pdf", Raph_map)

## OG simple map - gray CA outline
# # Get map data for California
# ca_map <- map_data("state", "california")
# 
# # Create ggplot object with California outline
# ggplot(ca_map, aes(x = long, y = lat, group = group)) +
#   geom_polygon(fill = "lightgray", colour = "white") +
#   coord_fixed(1.3)  # Adjust the aspect ratio if needed
# 
# # Add points to the plot
# ggplot(ca_map, aes(x = long, y = lat)) +
#   geom_polygon(fill = "lightgray", colour = "white") +
#   geom_point(data = occ2, aes(x = decimalLongitude, y = decimalLatitude, color = year)) +
#   scale_color_gradient(low = "blue", high = "red", limits = c(1857, 2023)) +
#   labs(title = "Lat Long Coordinates in California by Year", x = "Longitude", y = "Latitude") +
#   coord_fixed(1.3)  # Adjust the aspect ratio if needed

```

No need to combine as done below. gbif includes all CCH records...

Combine CCH2 and gbif specimen record data and plot again

```{r}

# Read in occurance data from CCH2 search for "Raphanus" (had to delete verbatim coordinates because contain crazy characters)

cch_full <- read.csv("CCH2_Raphanus_occurrences.csv", header = T)

# pare down CCH2 data: remove rows without a collection year, remove rows with no county AND no coordinates, remove " County" and "Co." from county names so each county only has one name.

string_to_remove <- c(" County", " Co.")

cch <- cch_full %>%

  select(simplifiedName, year, stateProvince, county, decimalLatitude, decimalLongitude, recordedBy, basisOfRecord) %>%

#  filter(stateProvince == "California") %>%

  drop_na(year) %>%

  filter(!is.na(decimalLatitude) & !is.na(county)) %>%

  mutate(county = str_remove_all(county, paste(string_to_remove, collapse = "|")))

# Read in gbif data; search for "Raphanus L.", occurance status present, with or without coordinates, and US only.

# Citation: GBIF.org (20 July 2023) GBIF Occurrence Download https://doi.org/10.15468/dl.2srzch

gbif_full <- read.csv("gbif_Raphanus_all_present.csv", header = T)

# pare down gbif data:

gbif <- gbif_full %>%

  select(simplifiedName, year, stateProvince, county, decimalLatitude, decimalLongitude, recordedBy, basisOfRecord) %>%

  drop_na(year) %>%

  filter(!is.na(decimalLatitude) & !is.na(county)) %>%

  mutate(county = str_remove_all(county, paste(string_to_remove, collapse = "|")))

# Join the datasets

comb_full <- gbif %>%

  full_join(cch, by = c("scientificName", "year", "stateProvince", "county", "decimalLatitude", "decimalLongitude", "recordedBy", "basisOfRecord"))

comb_anti <- gbif %>%

  anti_join(cch, by = c("scientificName", "year", "stateProvince", "county", "decimalLatitude", "decimalLongitude", "recordedBy", "basisOfRecord"))

#Test joining with mapping:

# get map

# register_google(key = "AIzaSyB39SQ16tq5W05hnFRHx6CVSKzH1iq1Mf0")

map <- get_map(location = c(lon=-100 , lat= 40), zoom =3, maptype = "terrain")

ggmap(map)

comb_spec <- comb_full %>%

filter(basisOfRecord == "PRESERVED_SPECIMEN")

Raph_spec_map_full <- ggmap(map) +

  geom_point(data = comb_spec, size = 2, pch = 21, colour="black", aes(x = decimalLongitude, y = decimalLatitude, fill = year)) +

  ylim(14,52) +

  xlim(-127, -56) +

  scale_fill_distiller(palette = "Spectral") +

  labs(title = "Raphanus spp. specimen collection locations")

# fill missing lat and long with the average lat or long for that county

comb2 <- comb%>%

  filter(!county =="") %>%

  group_by(county) %>%

  mutate(decimalLatitude = ifelse(is.na(decimalLatitude), mean(decimalLatitude, na.rm = TRUE), decimalLatitude),

         decimalLongitude = ifelse(is.na(decimalLongitude), mean(decimalLongitude, na.rm = TRUE), decimalLongitude)) %>%

  drop_na(decimalLatitude)

```
